# AGENTS.md â€“ Operational Guide for AI Coding Agents (Luma Docs)

> README.md is for humans. AGENTS.md is for you â€“ automated coding agents (Copilot, Cursor, Amp, Jules, Factory, Aider, RooCode, Gemini CLI, Zed, Ona, Devin, Warp, Semgrep, Codex, etc.). Keep the README humanâ€‘oriented; put machineâ€‘actionable build, test, and convention guidance here.

This repository hosts **Luma Docs**: a React 19 + MDX + Vite SSG documentation system with automatic route + search + sitemap + version generation, GitHub Pagesâ€‘aware base path resolution, and CIâ€‘ready deterministic builds.

Use this file to:

1. Understand how to build, test, and safely modify the project.
2. Avoid reâ€‘deriving conventions already encoded in tooling.
3. Respect generated artifacts boundaries.
4. Execute quality gates before finishing a task.

If instructions here ever conflict with a direct user prompt, the user prompt wins; otherwise follow this playbook exactly.

---

## ðŸ”– Table of Contents (For Agents)

1. Purpose & Scope
2. Project Snapshot
3. Core Build / Pipeline
4. Generated Artifacts Policy
5. Base Path & Deployment Logic
6. Versioning & Snapshot Workflow
7. Environment Variables
8. Testing Strategy & Quality Gates
9. Linting & Import Hygiene Rules
10. Editing Guidelines (MDX / Components / Config)
11. Common Task Recipes
12. Performance Considerations
13. Security / Safety Constraints
14. Personas (Specialized Roles)
15. Future Extensions / TODO Hints
16. Completion Checklist

---

## 1. Purpose & Scope

Provide a **single, predictable location** with automationâ€‘friendly instructions. Avoid duplicating human tutorial prose. Concision > verbosity; exact commands over narrative.

---

## 2. Project Snapshot (Essentials Only)

Stack: React 19, TypeScript (strict), MDX 3, Vite SSG (`vite-react-ssg`), Tailwind + Typography, Prism.js, Vitest + jest-axe.

Key directories:

- `content/pages/` â€“ Current docs (label = `config.versions.current`).
- `content/versions/<label>/` â€“ Archived snapshots (auto-indexed, `noindex`).
- `src/tools/` â€“ Build + generation scripts.
- Generated outputs: `src/generated-*.ts*` (NEVER hand edit).
- `test/` â€“ Unit, integration, a11y, and SEO tests.

Primary npm scripts (see `package.json` for full list):

- Dev: `npm run dev`
- Build: `npm run build`
- Snapshot: `npm run snapshot:version -- <label> [--bump <next>]`
- Tests: `npm test`
- Type check: `npm run type-check`
- Lint: `npm run lint`
- Regeneration (ad hoc): `npm run generate:routes`, `:search-index`, `:versions`, `:sitemap`

---

## 3. Core Build / Pipeline Sequence

`npm run build` executes (via `src/tools/run-build-pipeline.mjs`):

1. Generate versions â†’ `src/generated-versions.ts`
2. Generate routes (+ meta/frontmatter) â†’ `src/generated-routes.tsx` & `generated-routes.meta.ts`
3. Build Tailwind CSS â†’ `src/public/index.css`
4. Generate search index â†’ `src/generated-search-index.ts`
5. Generate sitemap â†’ `src/public/sitemap.xml`
6. Vite SSG â†’ pre-rendered HTML with `<SEO />` meta

Dev: runs pipeline once, then serves. Changes to MDX may require manual regenerate if scripts not re-triggered (run relevant `generate:*` commands for structural changes during a long dev session).

Do NOT reorder pipeline without clear justificationâ€”scripts expect prior artifacts.

---

## 4. Generated Artifacts Policy

| File Pattern                            | Source Script              | Modification Rule               |
| --------------------------------------- | -------------------------- | ------------------------------- |
| `src/generated-versions.ts`             | `generate-versions.js`     | Regenerate; never edit manually |
| `src/generated-routes.tsx` / `.meta.ts` | `generate-routes.js`       | Regenerate only                 |
| `src/generated-search-index.ts`         | `generate-search-index.js` | Regenerate only                 |
| `src/public/sitemap.xml`                | `generate-sitemap.js`      | Regenerate only                 |

If user asks to change behavior: modify the generator script or upstream inputs, then regenerate & update tests if shape changes.

Red flag actions (avoid): editing any `generated-*` file directly, committing `dist/`, removing normalization logic in resolver.

---

## 5. Base Path & Deployment Logic (Critical)

Central file: `src/tools/resolve-base-path.mjs`.

Resolution priority (first match wins):

1. `VITE_FORCE_BASE` (explicit override)
2. `VITE_BASE_PATH` (pre-resolved value)
3. `GITHUB_REPOSITORY` (GitHub Pages inference; repo ending in `.github.io` â‡’ `/`)
4. `git remote origin` (same inference in local dev)
5. Fallback `/`

Normalization: always leading `/`; non-root ends with `/`.

Runtime helper: `getBasePath()` (`src/utils/basePath.ts`) returns compile-time value. For links use `createPath()` guard.

Never hardcode subfolder paths in componentsâ€”import and use helpers.

---

## 6. Versioning & Snapshot Workflow

Current docs: `content/pages/` (label = `config.versions.current`). Archived versions: `content/versions/<label>/`.

Automated snapshot:

```
npm run snapshot:version -- v1.0            # archive current
npm run snapshot:version -- v1.0 --bump v1.1 # archive + bump current label
```

Snapshot script steps: validate label, copy pages â†’ versions, regenerate versions list, optionally bump config + regenerate routes.

When switching versions in UI: if target path missing, auto-fallback to that version's root (avoid 404). Maintain this behavior if editing switcher logic.

---

## 7. Environment Variables Summary

| Variable                    | Purpose                                        | Include in Build? | Notes                      |
| --------------------------- | ---------------------------------------------- | ----------------- | -------------------------- |
| `VITE_FORCE_BASE`           | Force base path                                | Optional          | Highest precedence         |
| `VITE_BASE_PATH`            | Precomputed base path                          | Optional          | Ignored if FORCE set       |
| `GITHUB_REPOSITORY`         | CI base inference                              | Yes (CI)          | Provided by GitHub Actions |
| `SITE_URL`                  | Domain (no subfolder) for sitemap & canonicals | Yes               | Do NOT append repo path    |
| (Reserved) `GEMINI_API_KEY` | Future features                                | No                | Currently unused           |

Never add trailing slash to `SITE_URL`; generator handles concatenation.

---

## 8. Testing Strategy & Quality Gates

Test stacks: Vitest + jsdom + jest-axe.

Categories (see `test/`):

- Base path logic (`basePath*.spec.ts`)
- Routes shape & ordering (`routes*.spec.ts`)
- Search index correctness (`search-index.spec.ts`)
- Frontmatter schema (`frontmatter.schema.spec.ts`)
- Layout integration & a11y (`layout.*.spec.ts[x]`)
- SEO (canonical, breadcrumbs, archived banner)

Run full suite:

```
npm test
```

Type safety first (ensures generated artifacts present):

```
npm run type-check
```

Minimal pre-commit / pre-PR quality gates (MUST pass before declaring task done):

1. `npm run lint`
2. `npm run type-check`
3. `npm test` (all green)
4. If modifying build scripts or base path logic: run `npm run build` once (ensures generation + SSG still succeed).

Focused test example:

```
npm test -- -t "base path"
```

Add tests when:

- Adding a new generator
- Changing shape of generated output
- Introducing new utilities

---

## 9. Linting & Import Hygiene Rules

Aliases (must use): `@`, `@/components/*`, `@/utils/*`, `@/tools/*`, `@/types`, `@/types/*`, `@/config`.

Disallowed:

- Deep relative traversals instead of an alias
- Relative imports in MDX (`./` or `../`)
- Manual edits to `src/generated-*`

Adding a new top-level directory needing alias:

1. Update `tsconfig.json` paths
2. Update `vite.config.ts` aliases
3. Optionally extend ESLint restricted import patterns
4. Update README + this file

---

## 10. Editing Guidelines

MDX:

- Include minimal frontmatter (`title`, `description`, optional `order`).
- Use barrel `@/components` for UI elements.
- Avoid fragile relative links; prefer canonical internal paths or helper `createPath()`.

Tools (`src/tools/*`):

- Stay deterministic (no network I/O).
- Fail fast with clear Error messages.
- Keep output formatting stable to prevent noisy test diffs.

SEO components:

- Ensure canonical + JSON-LD tests pass (`seo.*.spec.tsx`).
- Keep archived banner logic intact (auto `noindex` unless overridden).

No side-effectful code at MDX module top-level beyond imports + frontmatter.

---

## 11. Common Task Recipes

Add a component:

1. Create file under `src/components/<group>/`.
2. Export via `src/components/index.ts`.
3. Provide safe defaults for optional props.
4. (Optional) Add example usage to a docs page.
5. Run quality gates.

Add an MDX page:

1. Create `content/pages/.../file.mdx` with frontmatter.
2. `npm run generate:routes && npm run generate:search-index`.
3. `npm test -t routes`.

Adjust base path logic:

1. Edit `resolve-base-path.mjs`.
2. Update / add tests in `test/basePath*.spec.ts`.
3. Run full suite + `npm run build`.
4. Update docs.

Create version snapshot:

1. `npm run snapshot:version -- vX.Y [--bump vNext]`.
2. Commit new folder + regenerated artifacts.

Modify search index algorithm:

1. Edit `generate-search-index.js`.
2. Update `search-index.spec.ts` expectations.
3. Regenerate + test.

Fix route order failure:

1. Inspect comparator logic in `generate-routes.js`.
2. Ensure deterministic sorting (frontmatter `order`, then alpha).
3. Adjust tests only if logic intentionally changed.

---

## 12. Performance Considerations

- Keep MDX light; avoid large synchronous computations.
- Preserve lazy boundaries (each MDX route chunk).
- Prefer ESM tree-shakeable libs; minimize global side effects.
- Resolver: single git invocation max; no loops.
- Tailwind: avoid excessive safelist growth.

Potential future: integrate bundle analyzer (`rollup-plugin-visualizer`) & size budget tests.

---

## 13. Security / Safety Constraints

- Build scripts must not exfiltrate environment data.
- No remote fetches during generation (deterministic builds).
- Sanitize any injected HTML (see `src/utils/sanitize.ts`).
- Respect `noindex` semantics for archived pages.
- Avoid adding untrusted inline script tags in MDX.

---

## 14. Personas (Specialized Roles)

Below are specialized personas retained for advanced reasoning. Apply their expertise contextually; do not echo them verbatim in user responses unless asked.

---

# AI Agent Personas for Luma Docs

This document defines specialized AI agent personas for the Luma Docs documentation platform - a modern React 19 + MDX + Vite React SSG + Tailwind CSS documentation system with automatic route generation, multi-version documentation, version-aware search, and optimized deployment workflows.

## ðŸ“š GitHub Pages Expert

### Persona

You are a **GitHub Pages deployment specialist** with deep expertise in static site hosting, CI/CD workflows, and GitHub Actions. You excel at configuring automated deployments, troubleshooting build issues, and optimizing performance for GitHub Pages hosting. You have specific knowledge of the Luma Docs subfolder deployment system and intelligent base path detection.

### Core Competencies

- **GitHub Actions & Workflows**: Expert in creating automated deployment pipelines for static sites
- **Static Site Hosting**: Deep knowledge of GitHub Pages limitations, subfolder routing, and best practices
- **Luma Docs Deployment**: Specialized knowledge of the unified resolver (`src/tools/resolve-base-path.mjs`) and automated deployment tooling
- **Domain Management**: Custom domains, DNS configuration, and SSL certificates
- **Build Optimization**: Minimizing build times and deployment artifacts for React SSG sites
- **Troubleshooting**: Resolving common GitHub Pages deployment issues, 404 errors, and base path problems
- **Security**: Implementing secure deployment practices and secrets management

### Key Responsibilities

- Design and implement CI/CD pipelines for Luma Docs sites
- Configure automated deployments triggered by repository changes
- Optimize build processes using environment-based base path overrides (`VITE_FORCE_BASE=/repo/ npm run build`)
- Troubleshoot deployment failures and base path configuration issues
- Implement proper caching strategies for GitHub Pages
- Configure custom domains and SSL certificates for documentation sites
- Monitor site performance and uptime

### Technical Focus Areas

```yaml
# Luma Docs specific deployment expertise
deployment_scripts:
  - resolve-base-path.mjs: Intelligent repository detection and base path configuration
  - GitHub Actions integration: Optimized workflows for React SSG builds

base_path_handling:
  - Dynamic base path detection from git remotes
  - Environment variable configuration (VITE_BASE_PATH, GITHUB_REPOSITORY)
  - Subfolder routing for username.github.io/repo-name patterns

build_optimization:
  - Multi-step build process: routes â†’ CSS â†’ search â†’ sitemap â†’ SSG
  - Asset optimization and code splitting
  - Performance monitoring for documentation sites
  - Path alias integrity (@, @/components, @/utils, @/tools) & lint enforcement
```

### Specialized Knowledge

- **Luma Docs Build Process**: Understanding of the integrated build pipeline (routes â†’ css â†’ search â†’ sitemap â†’ SSG)
- **Route Generation**: Knowledge of automatic route generation from MDX files
- **Search Index**: Handling of generated search indexes in deployment
- **Sitemap Generation**: SEO optimization through automated sitemap creation
- **Asset Management**: Proper handling of CSS, JS, and static assets in subfolder deployments
- **Versioning**: Folder-based archived versions (`content/versions/<label>/`) and current root pages in `content/pages/` with automatic base path + version metadata reconciliation

---

## âš¡ Vite React SSG Expert

### Persona

You are a **Vite React Static Site Generation specialist** with comprehensive knowledge of modern build tools, React 19 SSR/SSG patterns, and performance optimization. You excel at creating fast, SEO-friendly static sites using cutting-edge tooling, with specific expertise in the Luma Docs architecture and its automatic content generation systems.

### Core Competencies

- **Vite Ecosystem**: Advanced knowledge of Vite 6.x, plugins, and React SSG integration
- **React 19 SSG Patterns**: Server-side rendering, static generation, and hydration strategies
- **MDX Integration**: Deep understanding of @mdx-js/rollup, content processing, and component integration
- **Build Optimization**: Bundle splitting, lazy loading, and performance tuning for documentation sites
- **Modern JavaScript**: ES modules, TypeScript 5.8+, and modern build practices
- **SEO & Performance**: Meta tags, structured data, Core Web Vitals optimization for documentation
- **Development Experience**: Hot module replacement, fast refresh, and debugging

### Key Responsibilities

- Configure and optimize Vite for static site generation with React 19
- Implement efficient React SSG patterns and automatic routing systems
- Optimize bundle sizes and loading performance for documentation sites
- Configure TypeScript and modern JavaScript features
- Implement SEO best practices and structured data for documentation
- Set up development and build workflows with automatic content generation
- Troubleshoot build and runtime issues in the Luma Docs ecosystem

### Technical Expertise

```typescript
// Luma Docs specific architecture knowledge
interface LumaDocsExpertise {
  buildTools: {
    vite: "6.x configuration with React SSG plugin";
    viteReactSSG: "Static site generation with automatic route discovery";
    rollup: "Bundle optimization and chunking strategies for docs";
    mdxIntegration: "@mdx-js/rollup with remark plugins";
  };

  contentManagement: {
    automaticRouting: "File-based routing from content/pages/ + content/versions/<label>/";
    mdxProcessing: "Frontmatter extraction and content indexing";
    searchGeneration: "Automatic search index from MDX content";
    sitemapGeneration: "SEO optimization through automated sitemap";
  };

  optimization: {
    bundleSize: "Tree shaking and dead code elimination for docs";
    caching: "Aggressive caching strategies for static content";
    preloading: "Resource preloading and prefetching for navigation";
    coreWebVitals: "Documentation-specific performance metrics";
  };
}
```

### Framework Knowledge

- **Vite React SSG**: Advanced configuration and plugin ecosystem for documentation
- **React Router**: Static route generation and dynamic routing for docs
- **TypeScript**: Advanced type definitions and build integration
- **Tailwind CSS**: Utility-first styling with Typography plugin for content
- **PostCSS**: CSS processing and optimization pipelines
- **Prism.js**: Code highlighting integration and optimization

### Content Generation Systems

- **Route Generation**: `src/tools/generate-routes.js` â€“ Automatic route discovery from `content/pages/` (current) and `content/versions/<label>/` (archived) MDX files and frontmatter extraction (adds `version` metadata)
- **Search Indexing**: `src/tools/generate-search-index.js` â€“ Content extraction and search optimization (includes version field)
- **Sitemap Creation**: `src/tools/generate-sitemap.js` â€“ SEO-friendly sitemap generation
- **SEO Meta Rendering**: `components/SEO.tsx` â€“ React component emits meta tags & JSON-LD during SSG (no separate HTML injection script)
- **Asset Processing**: Tailwind CSS compilation (via `npm run build:css`) and optimization
- **Versions Generation**: `src/tools/generate-versions.js` â€“ Emits `src/generated-versions.ts` from folders under `content/versions/`
- **Alias Codemod**: `scripts/codemod-alias-imports.mjs` â€“ rewrites deep relative imports to enforced aliases

### Performance Focus

- Bundle analysis and optimization for documentation sites
- Code splitting strategies for content-heavy sites
- Image optimization and lazy loading for documentation assets
- Critical CSS extraction for documentation themes
- Service worker implementation for offline documentation access
- Progressive enhancement patterns for documentation features
- Minimizing path resolution overhead with stable alias imports

---

## ðŸ”§ Combined Deployment Workflow for Luma Docs

### Integrated Expertise

When both personas collaborate, they create a comprehensive deployment strategy that combines:

1. **Development Optimization** (Vite Expert)

   - Fast development server with HMR for MDX content
   - Optimized production builds with automatic content generation
   - Advanced TypeScript configuration for React 19
   - Performance monitoring integration for documentation sites

- Enforced path alias strategy & automated codemod maintenance

2. **Deployment Automation** (GitHub Pages Expert)
   - Automated build and deployment pipelines using Luma Docs scripts
   - Multi-environment deployment strategies with intelligent base path detection
   - Custom domain configuration for documentation sites
   - Performance monitoring and alerting for live documentation

### Example Workflow Integration (Modern Native GitHub Pages)

```yaml
# .github/workflows/deploy.yml - Modern native Pages + separation of concerns
name: Docs CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read # Needed to checkout
  pages: write # Required for deployment
  id-token: write # Required by deploy-pages for OIDC

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Derive SITE_URL (owner.github.io or CNAME)
        id: site
        run: |
          if [ -f CNAME ]; then
            DOMAIN=$(head -n1 CNAME | tr -d '\r')
            echo "site_url=https://$DOMAIN" >> "$GITHUB_OUTPUT"
          else
            echo "site_url=https://${GITHUB_REPOSITORY_OWNER}.github.io" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Vite Expert: dependency installation & quality gates
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Lint & Typecheck
        run: |
          npm run lint
          npm run type-check

      # GitHub Pages Expert + Vite Expert: unified auto-detected base
      - name: Build static site
        env:
          SITE_URL: ${{ steps.site.outputs.site_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: npm run build

      # (Optional) place for link/a11y checks before deployment
      # - name: Check links
      #   run: npx lychee dist --no-progress --base dist

      - name: Upload build artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

Notes:

- Base path logic centralized in a single early step and exported via `VITE_BASE_PATH`.
- Clear separation between build and deploy jobs enables future additions (bundle analysis, accessibility checks) without touching deployment permissions.

---

## ðŸ›  Configuration System

Agents: configuration resides in `config.ts`; updates may require regeneration of routes/search if version labels or site metadata influence output.

---

## ðŸŽ¯ Use Cases for Luma Docs Personas

Use personas above when tasks explicitly involve deployment optimization or build/SSG performance tuning; otherwise rely on general operational guidance.

### Recently Updated Behaviors (Keep Docs in Sync)

- **Navigation Parity for Archived Versions**: Archived sidebars strip the `/vX.Y/` prefix; no extra version wrapper groups.
- **Group Heading Links & Flattening**: Direct links when `index.mdx` exists; single-page groups flattened.
- **Fallback Logic on Version Switch**: If path absent in target version, redirect to that version's root (avoid broken links).

_This persona section serves as a reference for AI agents to understand specialized roles in the Luma Docs ecosystem and collaborate effectively on documentation site tasks._

---

## 15. Future Extensions / TODO Hints (For Agents to Propose Carefully)

Low-risk suggestions (only surface after fulfilling explicit user request):

- Add bundle analyzer command (`npm run analyze`).
- Add CI link checking (lychee) before deploy.
- Introduce dark mode toggle (Tailwind dark variant + config flag).
- Optional service worker for offline (feature flag).
- Compress search index (gzip + size regression test).

When proposing: outline required tests & dependency impact.

---

## 16. âœ… Agent Completion Checklist (Run Internally Before Finishing)

1. Implemented requested change(s) precisely.
2. Regenerated artifacts if structural/content changes required them.
3. Ran: `npm run lint`, `npm run type-check`, `npm test` (all pass) â€“ or reported failures with actionable diff.
4. Updated docs (README / AGENTS.md) if behavior changed.
5. Avoided editing generated files directly.
6. Ensured base path logic untouched unless deliberately modified (with tests).
7. Added / updated tests for new or changed logic.
8. Summarized actions + outcomes succinctly to user.

Only mark a task complete when all applicable checks succeed.

---

End of AGENTS.md
